<?
define("_MENU","index");
include "./configs/config.inc.php";
include "lib.inc.php";

$ServerName		= $_SERVER['HTTP_HOST'];

pagePermit(false,@$_MEMB_ID,"intro.htm");

$tpl_file_nm = "index.tpl_test.html";

$lsQry = "SELECT *, ";
$lsQry.= "(SELECT DISTINCT(memb_nm) FROM memb WHERE local_nm = t1.local_nm AND memb_class = '3') AS teacher_nm, ";
$lsQry.= "(SELECT count(*) FROM memb WHERE local_nm = t1.local_nm AND memb_class = '4') AS tot_stud, ";
$lsQry.= "(SELECT count(*) FROM memb WHERE local_nm = t1.local_nm AND memb_class = '4' AND out_yn = '1') AS tot_stud_c, ";
$lsQry.= "(SELECT count(*) FROM memb WHERE local_head_nm = t1.local_head_nm AND memb_class = '3') AS tot_ga, ";
$lsQry.= "(SELECT count(*) FROM memb WHERE memb_class = '2') AS tot_area_all, ";
$lsQry.= "(SELECT count(*) FROM memb WHERE memb_class = '3') AS tot_ga_all, ";
//$lsQry.= "(SELECT count(*) FROM memb WHERE memb_class = '4' AND out_yn = '1' ) AS tot_stud_all, ";

//$lsQry.= "(SELECT COUNT(*) FROM memb WHERE online != 'Y' and memb_class = '4' AND out_yn = '1' and local_chong_nm IN (select local_chong_nm from memb where online != 'Y' and memb_class = '5' AND out_yn = '1') and local_nm!='????  ???' and online != 'Y' and memb_class = '4' AND out_yn = '1') AS tot_stud_all, ";
$lsQry.= "(SELECT COUNT(*) FROM memb WHERE memb_class = '4' AND out_yn = '1' and online = 'N' and local_nm!='????  ???') AS tot_stud_all, ";

$lsQry.= "(SELECT count(*) FROM memb WHERE memb_class = '4' ) AS tot_stud_all_plus, ";
$lsQry.= "(SELECT count(*) FROM memb WHERE memb_class = '5' ) AS tot_chong_all, ";
$lsQry.= "(SELECT count(*) FROM memb WHERE memb_class = '6' ) AS tot_ji_all, ";

// ????/??u
$lsQry.= "(SELECT count(*) FROM memb WHERE local_chong_nm = t1.local_chong_nm AND memb_class = '6' ) AS tot_ji_chong, ";
$lsQry.= "(SELECT count(*) FROM memb WHERE local_chong_nm = t1.local_chong_nm AND memb_class = '2') AS tot_area_chong, ";
$lsQry.= "(SELECT count(*) FROM memb WHERE local_chong_nm = t1.local_chong_nm AND memb_class = '3') AS tot_ga_chong, ";
$lsQry.= "(SELECT count(*) FROM memb WHERE local_chong_nm = t1.local_chong_nm AND memb_class = '4') AS tot_stud_chong, ";
//$lsQry.= "(SELECT count(*) FROM memb WHERE local_chong_nm = t1.local_chong_nm AND memb_class = '4' AND out_yn = '1') AS tot_stud_c_chong, ";
$lsQry.= "(SELECT COUNT(*) FROM memb WHERE local_chong_nm=(select local_chong_nm from memb where memb_id='$_MEMB_ID') and online != 'Y' and memb_class = '4' AND out_yn = '1' and local_nm!='????  ???') AS tot_stud_c_chong, ";


// ????
$lsQry.= "(SELECT count(*) FROM memb WHERE local_ji_nm = t1.local_ji_nm AND memb_class = '2') AS tot_area_ji, ";
$lsQry.= "(SELECT count(*) FROM memb WHERE local_ji_nm = t1.local_ji_nm AND memb_class = '3') AS tot_ga_ji, ";
$lsQry.= "(SELECT count(*) FROM memb WHERE local_ji_nm = t1.local_ji_nm AND memb_class = '4') AS tot_stud_ji, ";
//$lsQry.= "(SELECT count(*) FROM memb WHERE local_ji_nm = t1.local_ji_nm AND memb_class = '4' AND out_yn = '1') AS tot_stud_c_ji, ";
$lsQry.= "(SELECT COUNT(*) FROM memb WHERE local_ji_nm = (SELECT local_ji_nm FROM memb WHERE memb_id = '$_MEMB_ID' AND memb_class = '6') and local_nm!='????  ???' and online != 'Y' and memb_class = '4' AND out_yn = '1' 
) AS tot_stud_c_ji, ";

//????????
$lsQry.= "(SELECT COUNT(*) FROM memb WHERE memb_class = '4' AND out_yn = '1' AND local_head_nm = (SELECT local_head_nm FROM memb WHERE memb_id = '$_MEMB_ID' AND memb_class = '2') and online = 'N' and local_nm!='????  ???') AS tot_stud_c_head, ";


$lsQry.= "(select to_char(min(start_date),'yy.mm.dd') from study_list where memb_id = t1.memb_id and status = 'C') AS onine_start_date, ";
$lsQry.= "(select to_char(max(end_date),'yy.mm.dd') from study_list where memb_id = t1.memb_id and status = 'C') AS onine_end_date, ";

$lsQry.= "(select to_char(max(end_date),'yy.mm.dd')::timestamp -to_char(now(),'yy.mm.dd')::timestamp + '1 days' from study_list where memb_id = t1.memb_id and status = 'C') AS onine_remain_date, ";

$lsQry.= "(SELECT memb_id FROM memb WHERE memb_class = '2' AND local_head_nm = t1.local_head_nm limit 1) AS under_local_head_id, ";
$lsQry.= "(SELECT memb_nm FROM memb WHERE memb_class = '2' AND local_head_nm = t1.local_head_nm limit 1 ) AS under_local_head_nm ";


$lsQry.= "FROM memb t1 ";
$lsQry.= "WHERE memb_id = '$_MEMB_ID' AND memb_class = '$_MEMB_CLASS' ";
//print $lsQry;

$_tmp=$_DB->getRow($lsQry, DB_FETCHMODE_ASSOC);
$_tmp['onine_remain_date'] = str_replace("s","",str_replace("day","",$_tmp['onine_remain_date']));
$_TPL->assign("login_info",$_tmp);

//echo $lsQry;

//echo "11111=".$_tmp['onine_remain_date'];

//if(DB::isError($_tmp)){die(mysql_error()."<br>".$_tmp->getMessage());}

// ????????
$lsQry = "SELECT * ";
$lsQry.= "FROM newscon ";
$lsQry.= "WHERE shop_no = 1 ";
$lsQry.= "AND news_sort_no = 1 ";
$lsQry.= "ORDER BY reg_dm DESC ";
$lsQry.= "LIMIT 3";
$_TPL->assign("News1",$_DB->getAll($lsQry, DB_FETCHMODE_ASSOC));

// ?????????
$lsQry = "SELECT * ";
$lsQry.= "FROM boardcont ";
$lsQry.= "WHERE shop_no = 1 ";
$lsQry.= "AND brd_no = 1 ";
$lsQry.= "ORDER BY crt_dm DESC ";
$lsQry.= "LIMIT 3";
$_TPL->assign("Board1",$_DB->getAll($lsQry, DB_FETCHMODE_ASSOC));


// ????????
$lsQry = "SELECT * ";
$lsQry.= "FROM boardcont ";
$lsQry.= "WHERE shop_no = 1 ";
$lsQry.= "AND brd_no = 2 ";
$lsQry.= "ORDER BY crt_dm DESC ";
$lsQry.= "LIMIT 3";
$_TPL->assign("Board2",$_DB->getAll($lsQry, DB_FETCHMODE_ASSOC));


// ????????
$lsQry = "SELECT * ";
$lsQry.= "FROM newscon ";
$lsQry.= "WHERE shop_no = 1 ";
$lsQry.= "AND news_sort_no = 2 ";
$lsQry.= "ORDER BY reg_dm DESC ";
$lsQry.= "LIMIT 1";
$_TPL->assign("News2",$_DB->getAll($lsQry, DB_FETCHMODE_ASSOC));

// ????????
$lsQry = "SELECT * ";
$lsQry.= "FROM boardcont ";
$lsQry.= "WHERE shop_no = 1 ";
$lsQry.= "AND brd_no = 4 ";
$lsQry.= "ORDER BY crt_dm DESC ";
$lsQry.= "LIMIT 3";
$_TPL->assign("News3",$_DB->getAll($lsQry, DB_FETCHMODE_ASSOC));

$today_day = date('Y-m-d');

if ($mode == "LOGIN_ACTION") {
	$lsQry = "SELECT memb_id, memb_class, memb_pow, memb_nm, local_nm, local_head_nm, online, local_chong_nm, local_ji_nm, memb_class, lesson_edate, kpassword FROM memb ";
	$lsQry .= "WHERE memb_id = '$ps_memb_id' AND (memb_pwd = '$ps_pass' or kpassword = '".sha1($ps_pass)."') AND out_yn = '1' ";

	$info = $_DB->getRow($lsQry);
	if ($info[0] == $ps_memb_id) {
		if ($info[9]=='3' && $info[10]< $today_day) { //        Ã¼Å©
			
			alertBack(" Ì¿ â°?         Ï´ .      Ú¿            Ö¼   .");
		
		} else {
			
			if($info[9]=='4'){
				$vquery1 = "select substring(reg_dm,1,8) as reg_dm from inout where memb_id = '$ps_memb_id' and div = '1' order by reg_dm desc limit 1";	//   
				$vRow1 = $_DB->getOne($vquery1);
				
				//echo $vRow1."<br />";
				$vquery2 = "select substring(reg_dm,1,8) as reg_dm from inout where memb_id = '$ps_memb_id' and div = '9' order by reg_dm desc limit 1";	//    
				$vRow2 = $_DB->getOne($vquery2);
				//echo $vRow2."<br />";
				if($vRow1){
					if($vRow2==''){
						alertBack("         Ô´Ï´ .      Ú¿           Ö¼   .");
						$url = "index.htm";
						meta($url);
						exit;
					}else if($vRow1 > $vRow2){
						alertBack("  Ò°          Ô´Ï´ .  Ù½        Ö¼   .   Å¸      Ú¿           Ö¼   .");
						$url = "index.htm";
						meta($url);
						exit;
					}
				}
			}
			
			$connect_dm = date("YmdHis");
			$lsQry = "UPDATE memb SET upd_dm = '$connect_dm' WHERE memb_id = '$info[0]' ";
			$_DB->query($lsQry);

			//		if( $info[1] == '4' ) {
			$lsQry = "INSERT INTO connect ( memb_id, ip, type ) VALUES ( '$ps_memb_id', '$REMOTE_ADDR', '1' ) ";
			$_DB->query($lsQry);
			//		}

			if ($info[1] == "4") { // Ï¹        ?
				HTTP_Session :: set('_MEMB_NAME', $info[3]);
			}
			elseif ($info[1] == "3") {
				HTTP_Session :: set('_MEMB_NAME', $info[4]);
			}
			elseif ($info[1] == "2") {
				HTTP_Session :: set('_MEMB_NAME', $info[5]);
			} else {
				HTTP_Session :: set('_MEMB_NAME', $info[4]);
			}

			HTTP_Session :: set('_MEMB_ID', $info[0]);
			HTTP_Session :: set('_MEMB_CLASS', $info[1]);
			HTTP_Session :: set('_MEMB_POW', $info[2]);
			HTTP_Session :: set('_MEMB_CHONG', $info[7]);
			HTTP_Session :: set('_MEMB_JI', $info[8]);

			HTTP_Session :: set('_MEMB_ONLINE', $info[6]);
            if(strpos($_SERVER["HTTP_HOST"], 'www') !== false) {  
			   $cookdomain = str_replace("www.", "", $_SERVER["HTTP_HOST"]); 
			} else {  
				$cookdomain =  $_SERVER["HTTP_HOST"]; 
			}  
			SetCookie("COOKIE_MEMB_ID", $info[0], time() + 9999999999, "/" );
         
			/*
			if($remain == "Y"){
				setcookie("_remain", "Y", time() + 9999999999, "/");
				setcookie("_remain_memb_id", $info[0], time() + 9999999999, "/");
			}else{
				setcookie("_remain", "", time() - 9999999999, "/");
				setcookie("_remain_memb_id", "", time() - 9999999999, "/");
			}
			*/

			//		if(!$url) $url = "index.htm";
			if ($info[11] == '' && $info[1] != '4') {
				$url = "index.htm";
				//meta($url);
				alertMetaReload('  Ð¹ È£       Ç¾    Ï´ .   Ð¹ È£          Ö¼   .', '/mypage.htm?mode=PASSWORD_FORM');
			} else {
				$url = "index.htm";
				meta($url);
			}
          if( $info[6] == "Y"){ //Online           È¸       ì¿?       Ñ´ .
			if ($info[1] == "4") { // Ï¹              
			// Ô±        È®   Ï°   Ô±Ý¿  Î¸     Ç¿     ÜµÐ´ .
			$studyListQry = "SELECT no ,status , end_date, (to_char(end_date,'yy.mm.dd')::timestamp -to_char(now(),'yy.mm.dd')::timestamp) as dts from study_list where memb_id = '$ps_memb_id' order by no desc limit 1  "; 
			//and status ='C'
			//echo $studyListQry;
		
			$infoSl = $_DB->getRow($studyListQry);
			
			$remaindate = str_replace("s","",str_replace("day","",$infoSl[3]));
				if (!$infoSl[0]) {
				  alertMetaReload(' Ô±Ýµ          Ï½Ã±   Ù¶  Ï´ .', '/chain1_2.html');
				  exit;
				}elseif($infoSl[0] && $infoSl[1]<> 'C'){
				  alertMetaReload('          Ô± È®  Ã³          Ï½Ã±   Ù¶  Ï´ .', '/index.htm');
				  exit;
				}elseif($infoSl[0] && $infoSl[2]< $today_day){
				  alertMetaReload(' Ì¿ â°?         Ï´ .  Ô±Ýµ          Ï½Ã±   Ù¶  Ï´ .', '/chain1_2.html');
				  exit;
				}elseif($infoSl[0] && $remaindate <= 5 ){
				  alertMetaReload(' Ì¿ â°?  '. $remaindate . '       Ò½  Ï´ .                 Ï½Ã±   Ù¶  Ï´ ..', '/chain1_2.html');
				  exit;
				}
			}
			}
			// echo "_MEMB_ID=".$_MEMB_ID;
			exit;
		
		} // ??????u?

	} else {
		alertBack("   Ìµ   Ç´    Ð¹ È£    Ù½  Ô·    Ö¼   !!");
	}
	
	exit;
}
elseif ($mode == "LOGOUT_ACTION") {

	//	if( $_MEMB_CLASS == '4' ) {
	$lsQry = "INSERT INTO connect ( memb_id, ip, type ) VALUES ( '$_MEMB_ID', '$REMOTE_ADDR', '2' ) ";
	$_DB->query($lsQry);
	//	}

	echo "logout";
	exit;
    SetCookie("COOKIE_MEMB_ID", "");
	HTTP_Session :: set('_MEMB_ID', '');
	HTTP_Session :: set('_MEMB_CLASS', '');
	HTTP_Session :: set('_MEMB_POW', '');
	HTTP_Session :: set('_MEMB_NAME', '');
	HTTP_Session :: set('SESS_CART', '');
	HTTP_Session :: set('SESS_ORDER', '');
	
	HTTP_Session :: clear();
	meta("intro.htm");
	exit;
}

include "action_main_menu123.php";

//print_a($_GET);
//print_a($_POST);
//print_a($_SESSION);
//print_a($_COOKIE);
$_TPL->assign("_remain",$_COOKIE['_remain']);
$_TPL->assign("_remain_memb_id",$_COOKIE['_remain_memb_id']);
$_TPL->setTemplate($tpl_file_nm);

$_TPL->displayTemplate();
//$_TPL->cache_lifetime = 1800; // 30 minutes 
HTTP_Session::updateIdle();

if ($_SERVER['REMOTE_ADDR']=='180.229.87.136' || $_SERVER['REMOTE_ADDR']=='175.211.95.82') { 
//echo $lsQry."<br>";
//echo $_MEMB_CLASS;
//echo $tpl_file_nm;
//echo $_SERVER["HTTP_HOST"];
//echo $COOKIE_MEMB_ID;
//echo "$_MEMB_ID". $_MEMB_ID;
}

//echo $tpl_file_nm; //index.tpl_test.html
?>
